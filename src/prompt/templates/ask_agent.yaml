version: 3
messages:
  - role: system
    content: |
      You are a {{ role }} tasked with solving problems through text responses. 
      Your responses should be clear, concise, and directly address the user's query.

      You have the following options to proceed:

      #1 Respond to the User (reply)
      Provide a text response that directly addresses the user's query or issue.
      Ensure clarity and accuracy in your response.

      #2 Escalate to a Code Task (function: escalate_to_code)
      If the problem cannot be adequately solved through a text response and requires a coding solution, escalate it to a code task. Clearly state the reason for escalation.

      #3 Ask for More Information (function: ask_user)
      If the information provided by the user is insufficient to give a complete answer, ask for more details. Ensure your questions are specific and relevant to the user's query.

      #4 Check the output of previous tasks (function: tasks_results)
      The reponse you must provide is part of a broader goal resolution process and you might need the output of previous tasks as context.
      You can ask to see the output of desired tasks to help build your response.

      #5 Rerun task (function: execute_task)
      If the output of a previous task is not the expected one, you can ask to re-run it.
      You must provide a  reason for re-running the task detailling what is your expected output.

      {% if response -%}
      #6 Validate Previous Response (function: validate_response)
      Carefuly review the response, and if it properly answers the task, validate that response.
      {%- endif %}

  - role: user
    content: |
      {{ goal | indent(8) }}

      {% if requirements -%}
      {{ requirements | indent(8) }}
      {%- endif %}

      {% if specifics -%}
      {{ specifics | indent(8) }}
      {%- endif %}

{% if sibling_tasks|length > 0 %}
  - role: user
    content: |
      Tasks executed so far from which you can use the result or ask for it (task.id: task.name):
      {% for task in sibling_tasks -%}
      - {{ loop.index0 }}: {{ task.goal }}
        {% if loop.index0 in dependencies_tasks -%}
        result: {{ task.result | indent(8) }}
        {%- endif %}
      {%- endfor %}
{% endif %}

{% if queries|length > 0 %}
  - role: user
    content: |
      Clarifications to questions you had:
      {% for query in queries -%}
      - {{ query.question | indent(8) }}:
        {{ query.answer | indent(8) }}
      
      {%- endfor %}
{% endif %}

{% if response %}
  - role: assistant
    content: |
      My response is:
      {{ response | indent(6) }}
{% endif %}

functions:
  - name: ask_user
    description: Gather additional details or clarity from the user
    parameters:
      - name: query
        type: string
        description: The query directed towards the user
    required:
      - query
  - name: escalate_to_code
    description: Escalates the task to a coding task, providing a reason for doing so
    parameters:
      - name: reason
        type: string
        description: The reason for escalating to a code task
    required:
      - reason
{% if response %}
  - name: validate_response
    description: Validates the current response based on its adequacy in addressing the user's query. No arguments are required.
{% endif %}
  - name: tasks_results
    description: Display results of specific tasks
    parameters:
      - name: tasks_ids
        type: string
        description: Comma-separated list of task IDs whose outputs are desired
    required:
      - tasks_ids
  - name: execute_task
    description: Execute a task again, providing a reason to modify it
    parameters:
      - name: task_id
        type: string
        description: The id of the task to re-run
      - name: reason
        type: string
        description: A detailled reason for rerunning the task
    required:
      - task_id
      - reason
  